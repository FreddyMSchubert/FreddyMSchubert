name: Update pinned repo cards

on:
    workflow_dispatch:
    schedule:
        - cron: "17 * * * *"

permissions:
    contents: write

jobs:
    pins:
        runs-on: ubuntu-latest
        steps:
            - uses: actions/checkout@v4

            - uses: actions/setup-node@v4
              with:
                  node-version: "22"

            - name: Clone github-readme-stats
              run: |
                  rm -rf /tmp/grs
                  git clone --depth 1 https://github.com/anuraghazra/github-readme-stats /tmp/grs

            - name: Install deps
              working-directory: /tmp/grs
              run: npm ci

            - name: Start github-readme-stats locally
              working-directory: /tmp/grs
              env:
                  GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
                  CACHE_SECONDS: "0"
              run: |
                  node express.js --port 9000 > /tmp/grs.log 2>&1 &
                  echo $! > /tmp/grs.pid
                  for i in {1..200}; do
                    if curl -fsS "http://127.0.0.1:9000/api?username=octocat" >/dev/null 2>&1; then
                      echo "Server is up."
                      break
                    fi
                    sleep 0.1
                  done
                  if ! curl -fsS "http://127.0.0.1:9000/api?username=octocat" >/dev/null 2>&1; then
                    echo "Server failed to start. Logs:"
                    cat /tmp/grs.log
                    exit 1
                  fi

            - name: Render pins + update README
              env:
                  GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
                  PROFILE_REPO: ${{ github.repository }}
              run: node .github/scripts/update-pins.mjs

            - name: Stop server
              if: always()
              run: |
                  if [ -f /tmp/grs.pid ]; then kill "$(cat /tmp/grs.pid)" || true; fi

            - name: Commit + push if changed
              run: |
                  if [ -n "$(git status --porcelain)" ]; then
                    git config user.name "github-actions[bot]"
                    git config user.email "github-actions[bot]@users.noreply.github.com"
                    git add README.md profile/pins
                    git commit -m "chore: update pinned repo cards"
                    git push
                  fi
