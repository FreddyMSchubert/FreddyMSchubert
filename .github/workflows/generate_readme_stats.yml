name: Generate README stats images

on:
    workflow_dispatch:
    schedule:
        - cron: "17 3 * * *" # daily at 03:17 UTC
    push:
        branches: [main]
        paths:
            - ".github/workflows/generate-readme-stats.yml"

permissions:
    contents: write

concurrency:
    group: readme-stats-images
    cancel-in-progress: false

jobs:
    build:
        runs-on: ubuntu-latest
        steps:
            - name: Checkout hosting repo
              uses: actions/checkout@v4
              with:
                  fetch-depth: 0

            - name: Clone github-readme-stats into workspace
              run: |
                  rm -rf github-readme-stats
                  git clone --depth 1 https://github.com/anuraghazra/github-readme-stats github-readme-stats

            - name: Use Node 22
              uses: actions/setup-node@v4
              with:
                  node-version: "22"

            - name: Install deps
              working-directory: github-readme-stats
              run: npm ci

            - name: Start local server
              working-directory: github-readme-stats
              env:
                  GITHUB_TOKEN: ${{ secrets.STREAK_GITHUB_TOKEN }}
              run: |
                  set -euo pipefail

                  PORT=9000 nohup npm start >"$RUNNER_TEMP/ghrs.log" 2>&1 &
                  echo "Server PID: $!"

                  # Wait up to 60s for the server
                  for i in {1..60}; do
                    if curl -fsS "http://127.0.0.1:9000/" >/dev/null; then
                      echo "Server is up."
                      exit 0
                    fi
                    sleep 1
                  done

                  echo "Server failed to start. Log:"
                  tail -200 "$RUNNER_TEMP/ghrs.log"
                  exit 1

            - name: Generate SVGs
              env:
                  USERNAME: FreddyMSchubert
              run: |
                  set -euo pipefail
                  mkdir -p generated

                  curl -fsS "http://127.0.0.1:9000/api?username=${USERNAME}&show_icons=true&theme=tokyonight&card_width=650" \
                    -o generated/github-stats.svg

                  curl -fsS "http://127.0.0.1:9000/api/top-langs?username=${USERNAME}&layout=donut&theme=tokyonight&card_width=320" \
                    -o generated/top-langs.svg

            - name: Commit to stats branch
              run: |
                  set -euo pipefail
                  BRANCH="stats"

                  git config user.name "github-actions[bot]"
                  git config user.email "github-actions[bot]@users.noreply.github.com"

                  git fetch origin "$BRANCH":"refs/remotes/origin/$BRANCH" || true

                  if git show-ref --verify --quiet "refs/remotes/origin/$BRANCH"; then
                    git switch -C "$BRANCH" "origin/$BRANCH"
                  else
                    git switch --create "$BRANCH"
                  fi

                  mkdir -p assets
                  cp -f generated/streak-stats.svg assets/streak-stats.svg

                  git add assets/streak-stats.svg

                  if git diff --cached --quiet; then
                    echo "No changes."
                    exit 0
                  fi

                  git commit -m "chore: update streak stats image"
                  git push -u origin "$BRANCH"
