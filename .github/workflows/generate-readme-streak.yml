name: Generate streak stats image

on:
    workflow_dispatch:
    schedule:
        - cron: "23 3 * * *" # daily 03:23 UTC

permissions:
    contents: write

concurrency:
    group: streak-stats-images
    cancel-in-progress: false

jobs:
    build:
        runs-on: ubuntu-latest
        steps:
            - name: Checkout main
              uses: actions/checkout@v4
              with:
                  fetch-depth: 0
                  ref: main

            - name: Build streak-stats Docker image
              run: |
                  rm -rf /tmp/github-readme-streak-stats
                  git clone --depth 1 https://github.com/DenverCoder1/github-readme-streak-stats /tmp/github-readme-streak-stats
                  docker build -t streak-stats /tmp/github-readme-streak-stats

            - name: Run streak-stats locally
              env:
                  STREAK_GITHUB_TOKEN: ${{ secrets.STREAK_GITHUB_TOKEN }}
              run: |
                  docker run -d --rm -p 8080:80 -e TOKEN="${STREAK_GITHUB_TOKEN}" --name streak-stats streak-stats

                  for i in {1..60}; do
                    curl -fsS "http://127.0.0.1:8080/" >/dev/null && break || true
                    sleep 1
                  done
                  curl -fsS "http://127.0.0.1:8080/" >/dev/null

            - name: Generate SVG
              env:
                  USERNAME: FreddyMSchubert
              run: |
                  mkdir -p generated
                  curl -fsS "http://127.0.0.1:8080/?user=${USERNAME}&theme=tokyonight&date_format=j%20M%5B%20Y%5D&card_width=320&card_height=200&hide_total_contributions=true" \
                    -o generated/streak-stats.svg

              - name: Commit versioned streak image to stats branch
                shell: bash
                run: |
                  set -euo pipefail

                  VERSION="${{ github.run_id }}"
                  BRANCH="stats"
                  FILE="assets/streak-stats-${VERSION}.svg"

                  git config user.name "github-actions[bot]"
                  git config user.email "github-actions[bot]@users.noreply.github.com"

                  git fetch origin "${BRANCH}" || true

                  rm -rf /tmp/stats-branch
                  if git show-ref --verify --quiet "refs/remotes/origin/${BRANCH}"; then
                    # Create/update local branch 'stats' to track remote
                    git branch -f "${BRANCH}" "origin/${BRANCH}"
                    git worktree add -B "${BRANCH}" /tmp/stats-branch "${BRANCH}"
                  else
                    # Create new local branch 'stats'
                    git worktree add -b "${BRANCH}" /tmp/stats-branch
                  fi

                  mkdir -p /tmp/stats-branch/assets
                  cp -f generated/streak-stats.svg "/tmp/stats-branch/${FILE}"

                  ls -1t /tmp/stats-branch/assets/streak-stats-*.svg 2>/dev/null | tail -n +5 | xargs -r rm -f

                  cd /tmp/stats-branch
                  git add assets/streak-stats-*.svg

                  if git diff --cached --quiet; then
                    echo "No changes."
                  else
                    git commit -m "chore: update streak stats image (cache-bust)"
                    # Push local branch explicitly to remote branch
                    git push origin "${BRANCH}:${BRANCH}"
                  fi

                  cd "${GITHUB_WORKSPACE}"

                  perl -0777 -i -pe 's#raw\.githubusercontent\.com/FreddyMSchubert/FreddyMSchubert/[^/]+/assets/streak-stats(?:-[0-9]+)?\.svg#raw.githubusercontent.com/FreddyMSchubert/FreddyMSchubert/stats/'"${FILE}"'#g' README.md

            - name: Commit README update in main
              run: |
                  git config user.name "github-actions[bot]"
                  git config user.email "github-actions[bot]@users.noreply.github.com"

                  git add README.md
                  git diff --cached --quiet || git commit -m "chore: update streak image link (cache-bust)"
                  git push origin main
