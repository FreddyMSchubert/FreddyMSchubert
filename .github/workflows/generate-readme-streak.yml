name: Generate streak stats image

on:
    workflow_dispatch:
    schedule:
        - cron: "23 3 * * *" # daily 03:23 UTC

permissions:
    contents: write

concurrency:
    group: streak-stats-images
    cancel-in-progress: false

jobs:
    build:
        runs-on: ubuntu-latest
        steps:
            - name: Checkout hosting repo
              uses: actions/checkout@v4
              with:
                  fetch-depth: 0

            - name: Build streak-stats Docker image
              run: |
                  rm -rf /tmp/github-readme-streak-stats
                  git clone --depth 1 https://github.com/DenverCoder1/github-readme-streak-stats /tmp/github-readme-streak-stats
                  docker build -t streak-stats /tmp/github-readme-streak-stats

            - name: Run streak-stats locally
              env:
                  STREAK_GITHUB_TOKEN: ${{ secrets.STREAK_GITHUB_TOKEN }}
              run: |
                  docker run -d --rm -p 8080:80 -e TOKEN="${STREAK_GITHUB_TOKEN}" --name streak-stats streak-stats

                  for i in {1..60}; do
                    curl -fsS "http://127.0.0.1:8080/" >/dev/null && break || true
                    sleep 1
                  done
                  curl -fsS "http://127.0.0.1:8080/" >/dev/null

            - name: Generate SVG
              env:
                  USERNAME: FreddyMSchubert
              run: |
                  mkdir -p generated
                  curl -fsS "http://127.0.0.1:8080/?user=${USERNAME}&theme=tokyonight&date_format=j%20M%5B%20Y%5D&card_width=320&card_height=200&hide_total_contributions=true" \
                    -o generated/streak-stats.svg

            - name: Commit to stats branch
              run: |
                  set -euo pipefail
                  BRANCH="stats"
                  git config user.name "github-actions[bot]"
                  git config user.email "github-actions[bot]@users.noreply.github.com"

                  git fetch origin "${BRANCH}" || true

                  if git show-ref --verify --quiet "refs/remotes/origin/${BRANCH}"; then
                    git switch -C "${BRANCH}" --track "origin/${BRANCH}"
                    git pull --ff-only
                  else
                    git switch -c "${BRANCH}"
                  fi

                  mkdir -p assets
                  cp -f generated/streak-stats.svg assets/streak-stats.svg

                  git add assets/streak-stats.svg
                  if git diff --cached --quiet; then
                    echo "No changes."
                    exit 0
                  fi

                  git commit -m "chore: update streak stats image"
                  git push origin "${BRANCH}"
